// prosemirror-gapcursor@1.3.2 downloaded from https://ga.jspm.io/npm:prosemirror-gapcursor@1.3.2/dist/index.js

import{keydownHandler as e}from"prosemirror-keymap";import{Selection as r,NodeSelection as t,Plugin as o,TextSelection as n}from"prosemirror-state";import{Slice as s,Fragment as i}from"prosemirror-model";import{DecorationSet as l,Decoration as a}from"prosemirror-view";class GapCursor extends r{constructor(e){super(e,e)}map(e,t){let o=e.resolve(t.map(this.head));return GapCursor.valid(o)?new GapCursor(o):r.near(o)}content(){return s.empty}eq(e){return e instanceof GapCursor&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,r){if("number"!=typeof r.pos)throw new RangeError("Invalid input for GapCursor.fromJSON");return new GapCursor(e.resolve(r.pos))}getBookmark(){return new GapBookmark(this.anchor)}static valid(e){let r=e.parent;if(r.isTextblock||!closedBefore(e)||!closedAfter(e))return false;let t=r.type.spec.allowGapCursor;if(null!=t)return t;let o=r.contentMatchAt(e.index()).defaultType;return o&&o.isTextblock}static findGapCursorFrom(e,r,o=false){e:for(;;){if(!o&&GapCursor.valid(e))return e;let n=e.pos,s=null;for(let t=e.depth;;t--){let o=e.node(t);if(r>0?e.indexAfter(t)<o.childCount:e.index(t)>0){s=o.child(r>0?e.indexAfter(t):e.index(t)-1);break}if(0==t)return null;n+=r;let i=e.doc.resolve(n);if(GapCursor.valid(i))return i}for(;;){let i=r>0?s.firstChild:s.lastChild;if(!i){if(s.isAtom&&!s.isText&&!t.isSelectable(s)){e=e.doc.resolve(n+s.nodeSize*r);o=false;continue e}break}s=i;n+=r;let l=e.doc.resolve(n);if(GapCursor.valid(l))return l}return null}}}GapCursor.prototype.visible=false;GapCursor.findFrom=GapCursor.findGapCursorFrom;r.jsonID("gapcursor",GapCursor);class GapBookmark{constructor(e){this.pos=e}map(e){return new GapBookmark(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return GapCursor.valid(t)?new GapCursor(t):r.near(t)}}function closedBefore(e){for(let r=e.depth;r>=0;r--){let t=e.index(r),o=e.node(r);if(0!=t)for(let e=o.child(t-1);;e=e.lastChild){if(0==e.childCount&&!e.inlineContent||e.isAtom||e.type.spec.isolating)return true;if(e.inlineContent)return false}else if(o.type.spec.isolating)return true}return true}function closedAfter(e){for(let r=e.depth;r>=0;r--){let t=e.indexAfter(r),o=e.node(r);if(t!=o.childCount)for(let e=o.child(t);;e=e.firstChild){if(0==e.childCount&&!e.inlineContent||e.isAtom||e.type.spec.isolating)return true;if(e.inlineContent)return false}else if(o.type.spec.isolating)return true}return true}function gapCursor(){return new o({props:{decorations:drawGapCursor,createSelectionBetween(e,r,t){return r.pos==t.pos&&GapCursor.valid(t)?new GapCursor(t):null},handleClick:handleClick,handleKeyDown:u,handleDOMEvents:{beforeinput:beforeinput}}})}const u=e({ArrowLeft:arrow("horiz",-1),ArrowRight:arrow("horiz",1),ArrowUp:arrow("vert",-1),ArrowDown:arrow("vert",1)});function arrow(e,r){const t="vert"==e?r>0?"down":"up":r>0?"right":"left";return function(e,o,s){let i=e.selection;let l=r>0?i.$to:i.$from,a=i.empty;if(i instanceof n){if(!s.endOfTextblock(t)||0==l.depth)return false;a=false;l=e.doc.resolve(r>0?l.after():l.before())}let u=GapCursor.findGapCursorFrom(l,r,a);if(!u)return false;o&&o(e.tr.setSelection(new GapCursor(u)));return true}}function handleClick(e,r,o){if(!e||!e.editable)return false;let n=e.state.doc.resolve(r);if(!GapCursor.valid(n))return false;let s=e.posAtCoords({left:o.clientX,top:o.clientY});if(s&&s.inside>-1&&t.isSelectable(e.state.doc.nodeAt(s.inside)))return false;e.dispatch(e.state.tr.setSelection(new GapCursor(n)));return true}function beforeinput(e,r){if("insertCompositionText"!=r.inputType||!(e.state.selection instanceof GapCursor))return false;let{$from:t}=e.state.selection;let o=t.parent.contentMatchAt(t.index()).findWrapping(e.state.schema.nodes.text);if(!o)return false;let l=i.empty;for(let e=o.length-1;e>=0;e--)l=i.from(o[e].createAndFill(null,l));let a=e.state.tr.replace(t.pos,t.pos,new s(l,0,0));a.setSelection(n.near(a.doc.resolve(t.pos+1)));e.dispatch(a);return false}function drawGapCursor(e){if(!(e.selection instanceof GapCursor))return null;let r=document.createElement("div");r.className="ProseMirror-gapcursor";return l.create(e.doc,[a.widget(e.selection.head,r,{key:"gapcursor"})])}export{GapCursor,gapCursor};

